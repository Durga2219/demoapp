<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Ride Sharing - Welcome</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #00674F 0%, #0A3C30 100%);
        min-height: 100vh;
        color: #FFFFFF;
    }

    nav {
        background: #00674F;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
        padding: 0 20px;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 80px;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 26px;
        font-weight: bold;
        color: #73E6CB;
        cursor: pointer;
    }

    .nav-buttons {
        display: flex;
        gap: 15px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-login {
        background: transparent;
        color: #73E6CB;
        border: 2px solid #73E6CB;
    }

    .btn-login:hover {
        background: #73E6CB;
        color: #00674F;
    }

    .btn-register {
        background: #3EBB9E;
        color: #FFFFFF;
    }

    .btn-register:hover {
        background: #73E6CB;
        color: #00674F;
        transform: translateY(-2px);
    }

    .hero {
        text-align: center;
        padding: 100px 20px;
        color: #FFFFFF;
    }

    .hero h1 {
        font-size: 56px;
        margin-bottom: 25px;
        font-weight: 700;
    }

    .hero p {
        font-size: 20px;
        margin-bottom: 40px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
    }

    .btn-cta {
        background: linear-gradient(135deg, #3EBB9E, #73E6CB);
        color: #FFFFFF;
        padding: 18px 36px;
        font-size: 18px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(62, 187, 158, 0.3);
    }

    .btn-cta:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(62, 187, 158, 0.4);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: #FFFFFF;
        margin: 5% auto;
        padding: 40px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: slideUp 0.3s ease;
        color: #333;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
    }

    .register-modal {
        max-width: 550px;
        max-height: 95vh;
    }

    .register-form-container {
        max-height: 65vh;
        overflow-y: auto;
        padding-right: 10px;
    }

    .register-form-container::-webkit-scrollbar {
        width: 6px;
    }

    .register-form-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .register-form-container::-webkit-scrollbar-thumb {
        background: #3EBB9E;
        border-radius: 3px;
    }

    .register-form-container::-webkit-scrollbar-thumb:hover {
        background: #2a8a73;
    }

    .close-btn {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 28px;
        font-weight: bold;
        background: none;
        border: none;
        cursor: pointer;
        color: #999;
    }

    .close-btn:hover {
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }

    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    .form-group input:focus {
        outline: none;
        border-color: #3EBB9E;
    }

    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        background-color: white;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .form-group select:focus {
        outline: none;
        border-color: #3EBB9E;
    }

    .profile-picture-group {
        text-align: center;
    }

    .profile-upload-container {
        margin-top: 10px;
    }

    .profile-upload-area {
        border: 2px dashed #3EBB9E;
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8fffe;
    }

    .profile-upload-area:hover {
        border-color: #2a8a73;
        background: #f0fdfb;
    }

    .upload-placeholder {
        text-align: center;
    }

    #profilePreview {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    #previewImage {
        box-shadow: 0 4px 15px rgba(62, 187, 158, 0.3);
    }

    .btn-submit {
        width: 100%;
        background: linear-gradient(135deg, #3EBB9E, #73E6CB);
        color: #FFFFFF;
        padding: 15px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(62, 187, 158, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .modal-footer {
        text-align: center;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #3EBB9E;
        color: #666;
        font-size: 14px;
    }

    .modal-footer a {
        color: #3EBB9E;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
    }

    .modal-footer a:hover {
        text-decoration: underline;
    }

    /* Alert Styles */
    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 500;
        display: none;
        text-align: center;
    }

    .alert.show {
        display: block;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .hero h1 {
            font-size: 36px;
        }

        .hero p {
            font-size: 18px;
        }

        .modal-content {
            margin: 10% auto;
            padding: 20px;
            width: 95%;
        }
    }
</style>
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-car"></i>
                <span>Dynamic Ride Sharing</span>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-login" onclick="openModal('login')">Login</button>
                <button class="btn btn-register" onclick="openModal('register')">Register</button>
            </div>
        </div>
    </nav>

    <div class="hero">
        <h1>Share Your Ride, Share Your Journey</h1>
        <p>Connect with fellow travelers, save money, and reduce your carbon footprint with our intelligent ride-sharing
            platform.</p>
        <button class="btn btn-cta" onclick="openModal('register')">Get Started Today</button>
    </div>

    <!-- Login Modal - Password Only -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('login')">&times;</button>
            <h2 style="text-align: center; margin-bottom: 20px; color: #73E6CB; font-size: 24px;">Welcome Back</h2>

            <div id="loginAlert" class="alert"></div>

            <form onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-submit" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>

            <div class="modal-footer">
                Don't have an account? <a onclick="switchModal('login', 'register')">Register here</a>
            </div>
        </div>
    </div>

    <!-- Registration Modal - OTP Based -->
    <div id="registerModal" class="modal">
        <div class="modal-content register-modal">
            <button class="close-btn" onclick="closeModal('register')">&times;</button>
            <h2 style="text-align: center; margin-bottom: 20px; color: #73E6CB; font-size: 24px;">Create Your Account
            </h2>

            <div id="registerAlert" class="alert"></div>

            <div class="register-form-container">
                <form onsubmit="event.preventDefault(); handleRegistrationWithOTP();">
                    <!-- Email with OTP Section -->
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email Address</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="email" id="registerEmail" placeholder="Enter your email" required style="flex: 1;">
                            <button type="button" class="btn-submit" id="sendOtpBtn" onclick="sendRegistrationOTP()" style="width: auto; padding: 12px 20px;">
                                <i class="fas fa-paper-plane"></i> Send OTP
                            </button>
                        </div>
                    </div>

                    <div class="form-group" id="otpGroup" style="display: none;">
                        <label><i class="fas fa-key"></i> Enter OTP (Check your email)</label>
                        <input type="text" id="registerOTP" placeholder="Enter 6-digit OTP" maxlength="6" pattern="\d{6}">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Full Name</label>
                        <input type="text" id="registerName" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Phone Number</label>
                        <input type="tel" id="registerPhone" placeholder="Enter 10-digit phone number" required pattern="\d{10}" maxlength="10">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password (min 6 characters)"
                            required minlength="6">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-user-tag"></i> I want to register as</label>
                        <select id="registerRole" onchange="toggleDriverFields()" required>
                            <option value="">Select your role</option>
                            <option value="PASSENGER">Passenger - I want to book rides</option>
                            <option value="DRIVER">Driver - I want to offer rides</option>
                            <option value="BOTH">Both - I want to book and offer rides</option>
                        </select>
                    </div>

                    <!-- Driver-specific fields -->
                    <div id="driverFields" style="display: none;">
                        <div class="form-group">
                            <label><i class="fas fa-car"></i> Vehicle Model (Required for Drivers)</label>
                            <input type="text" id="vehicleModel" placeholder="e.g., Toyota Camry 2020">
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-id-card"></i> Vehicle Plate Number (Required for Drivers)</label>
                            <input type="text" id="vehiclePlate" placeholder="e.g., ABC-1234">
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-users"></i> Vehicle Capacity (Required for Drivers)</label>
                            <input type="number" id="vehicleCapacity" placeholder="Number of seats (1-8)" min="1" max="8">
                        </div>
                    </div>

                    <div class="form-group profile-picture-group">
                        <label><i class="fas fa-camera"></i> Profile Picture (Optional)</label>
                        <div class="profile-upload-container">
                            <input type="file" id="registerProfilePicture" accept="image/*"
                                onchange="previewProfilePicture(this)" style="display: none;">
                            <div class="profile-upload-area"
                                onclick="document.getElementById('registerProfilePicture').click();">
                                <div id="profilePreview" style="display: none;">
                                    <img id="previewImage"
                                        style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #3EBB9E;">
                                </div>
                                <div id="uploadPlaceholder" class="upload-placeholder">
                                    <i class="fas fa-camera"
                                        style="font-size: 24px; color: #3EBB9E; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; color: #666; font-size: 14px;">Click to upload profile picture
                                    </p>
                                    <small style="color: #999; font-size: 12px;">JPG, PNG or GIF (Max 2MB)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
            </div>

            <div class="modal-footer">
                Already have an account? <a onclick="switchModal('register', 'login')">Sign in here</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api/auth';

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId + 'Modal').style.display = 'block';

            // Reset registration form when opening
            if (modalId === 'register') {
                resetRegistrationForm();
            }
        }

        // Reset registration form
        function resetRegistrationForm() {
            // Clear all fields
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerOTP').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerRole').value = '';
            document.getElementById('registerProfilePicture').value = '';
            document.getElementById('vehicleModel').value = '';
            document.getElementById('vehiclePlate').value = '';
            document.getElementById('vehicleCapacity').value = '';

            // Hide OTP field and driver fields
            document.getElementById('otpGroup').style.display = 'none';
            document.getElementById('registerOTP').required = false;
            document.getElementById('driverFields').style.display = 'none';

            // Reset profile picture preview
            const preview = document.getElementById('profilePreview');
            const placeholder = document.getElementById('uploadPlaceholder');
            if (preview) preview.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';

            // Clear alerts
            clearAlert('register');
        }

        function closeModal(modalId) {
            document.getElementById(modalId + 'Modal').style.display = 'none';
        }

        function switchModal(from, to) {
            closeModal(from);
            openModal(to);
        }

        // Alert Functions
        function showAlert(modalId, message, isSuccess) {
            const alertDiv = document.getElementById(modalId + 'Alert');
            if (alertDiv) {
                alertDiv.className = `alert ${isSuccess ? 'alert-success' : 'alert-error'} show`;
                alertDiv.textContent = message;
                alertDiv.style.display = 'block';
            }
        }

        function clearAlert(modalId) {
            const alertDiv = document.getElementById(modalId + 'Alert');
            if (alertDiv) {
                alertDiv.className = 'alert';
                alertDiv.textContent = '';
                alertDiv.style.display = 'none';
            }
        }

        // Login Function
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const btn = document.getElementById('loginBtn');

            if (!email || !password) {
                showAlert('login', 'Please enter both email and password', false);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Signing in...';
            clearAlert('login');

            try {
                console.log('üîÑ Logging in user:', email);
                console.log('üîë Password length:', password.length);
                console.log('üì° API URL:', `${API_BASE_URL}/login`);

                const loginData = {
                    username: email,
                    password: password
                };
                console.log('üì¶ Login data:', loginData);

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                console.log('üì° Response status:', response.status);

                const data = await response.json();
                console.log('üì¶ Login response:', data);

                if (!response.ok) {
                    console.log('‚ùå Login failed with status:', response.status);
                    console.log('‚ùå Error message:', data.message);
                    showAlert('login', data.message || `Login failed (${response.status})`, false);
                    return;
                }

                if (data.success && data.data) {
                    // Store authentication data in BOTH localStorage AND sessionStorage
                    // SessionStorage persists across navigation better
                    const tokenData = {
                        token: data.data.token,
                        user: data.data,
                        timestamp: Date.now()
                    };
                    
                    // Store in localStorage
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data));
                    localStorage.setItem('userData', JSON.stringify(data.data));
                    
                    // ALSO store in sessionStorage for immediate access
                    sessionStorage.setItem('token', data.data.token);
                    sessionStorage.setItem('authToken', data.data.token);
                    sessionStorage.setItem('user', JSON.stringify(data.data));
                    sessionStorage.setItem('userData', JSON.stringify(data.data));
                    
                    // ALSO store in cookie as backup
                    document.cookie = `authToken=${data.data.token}; path=/; max-age=86400`;
                    document.cookie = `userRole=${data.data.role}; path=/; max-age=86400`;

                    console.log('‚úÖ Auth data stored in localStorage, sessionStorage, AND cookies');
                    console.log('üé≠ User role:', data.data.role);
                    console.log('üíæ localStorage token:', localStorage.getItem('authToken') ? 'YES' : 'NO');
                    console.log('üíæ sessionStorage token:', sessionStorage.getItem('authToken') ? 'YES' : 'NO');
                    console.log('üç™ Cookie set:', document.cookie.includes('authToken') ? 'YES' : 'NO');

                    // Redirect based on user role
                    const userRole = data.data.role ? data.data.role.toString().toUpperCase() : 'PASSENGER';

                    console.log('‚û°Ô∏è Redirecting to dashboard for role:', userRole);

                    // Show success message
                    showAlert('login', '‚úÖ Login successful! Redirecting...', true);

                    // CRITICAL FIX: Pass token in URL to ensure dashboard gets it
                    console.log('‚è≥ Waiting 1000ms before redirect to ensure storage completes...');
                    setTimeout(() => {
                        console.log('üöÄ Now redirecting to dashboard WITH token in URL...');
                        const token = encodeURIComponent(data.data.token);
                        if (userRole === 'DRIVER' || userRole === 'BOTH') {
                            window.location.href = `/driver-dashboard.html?token=${token}`;
                        } else if (userRole === 'ADMIN') {
                            window.location.href = `/admin-dashboard.html?token=${token}`;
                        } else {
                            window.location.href = `/passenger-dashboard.html?token=${token}`;
                        }
                    }, 1000);

                } else {
                    showAlert('login', data.message || 'Invalid email or password', false);
                }

            } catch (error) {
                console.error('‚ùå Login error:', error);
                showAlert('login', 'Login failed. Please check your connection and try again.', false);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Profile picture preview function
        function previewProfilePicture(input) {
            const preview = document.getElementById('profilePreview');
            const previewImage = document.getElementById('previewImage');
            const placeholder = document.getElementById('uploadPlaceholder');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (2MB max for better compatibility)
                if (file.size > 2 * 1024 * 1024) {
                    showAlert('register', 'Profile picture must be less than 2MB for better performance', false);
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showAlert('register', 'Please select a valid image file', false);
                    input.value = '';
                    return;
                }

                const reader = new FileReader();

                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'flex';
                    placeholder.style.display = 'none';
                };

                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        // Convert image to base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Toggle driver fields based on role selection
        function toggleDriverFields() {
            const role = document.getElementById('registerRole').value;
            const driverFields = document.getElementById('driverFields');
            const vehicleModel = document.getElementById('vehicleModel');
            const vehiclePlate = document.getElementById('vehiclePlate');
            const vehicleCapacity = document.getElementById('vehicleCapacity');
            
            if (role === 'DRIVER' || role === 'BOTH') {
                driverFields.style.display = 'block';
                vehicleModel.required = true;
                vehiclePlate.required = true;
                vehicleCapacity.required = true;
            } else {
                driverFields.style.display = 'none';
                vehicleModel.required = false;
                vehiclePlate.required = false;
                vehicleCapacity.required = false;
            }
        }

        // Send OTP to email for registration
        async function sendRegistrationOTP() {
            const email = document.getElementById('registerEmail').value.trim();
            const btn = document.getElementById('sendOtpBtn');

            if (!email) {
                showAlert('register', 'Please enter your email address', false);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            clearAlert('register');

            try {
                console.log('üìß Sending registration OTP to:', email);

                const response = await fetch(`${API_BASE_URL}/send-registration-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                console.log('üì¶ OTP response:', data);

                if (data.success) {
                    showAlert('register', '‚úÖ OTP sent to your email! Check your inbox and enter it below.', true);
                    
                    // Show OTP field
                    document.getElementById('otpGroup').style.display = 'block';
                    document.getElementById('registerOTP').required = true;
                    document.getElementById('registerOTP').focus();

                } else {
                    showAlert('register', data.message || 'Failed to send OTP. Please try again.', false);
                }

            } catch (error) {
                console.error('‚ùå OTP send error:', error);
                showAlert('register', 'Failed to send OTP. Please check your connection.', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
            }
        }

        // Complete Registration with OTP
        async function handleRegistrationWithOTP() {
            console.log('üöÄ Starting OTP registration...');

            const email = document.getElementById('registerEmail').value.trim();
            const otp = document.getElementById('registerOTP').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const role = document.getElementById('registerRole').value;
            const profilePictureFile = document.getElementById('registerProfilePicture').files[0];
            const btn = document.getElementById('registerBtn');

            // Validation
            if (!email) {
                showAlert('register', 'Please enter your email', false);
                return;
            }

            if (!otp || otp.length !== 6) {
                showAlert('register', 'Please send OTP and enter the 6-digit code', false);
                return;
            }

            if (!name || !phone || !password || !role) {
                showAlert('register', 'Please fill in all required fields', false);
                return;
            }

            if (phone.length !== 10 || !/^\d{10}$/.test(phone)) {
                showAlert('register', 'Phone number must be exactly 10 digits', false);
                return;
            }

            if (password.length < 6) {
                showAlert('register', 'Password must be at least 6 characters', false);
                return;
            }

            // Driver validation
            if (role === 'DRIVER' || role === 'BOTH') {
                const vehicleModel = document.getElementById('vehicleModel').value.trim();
                const vehiclePlate = document.getElementById('vehiclePlate').value.trim();
                const vehicleCapacity = document.getElementById('vehicleCapacity').value;

                if (!vehicleModel || !vehiclePlate || !vehicleCapacity) {
                    showAlert('register', 'Drivers must provide vehicle information', false);
                    return;
                }

                if (parseInt(vehicleCapacity) < 1 || parseInt(vehicleCapacity) > 8) {
                    showAlert('register', 'Vehicle capacity must be between 1 and 8', false);
                    return;
                }
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            clearAlert('register');

            try {
                let profilePictureBase64 = null;

                // Convert profile picture if uploaded
                if (profilePictureFile) {
                    try {
                        profilePictureBase64 = await getBase64(profilePictureFile);
                        console.log('üì∑ Profile picture converted');
                    } catch (error) {
                        console.error('‚ùå Image error:', error);
                        showAlert('register', 'Error processing profile picture', false);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                        return;
                    }
                }

                // Build request
                const registerData = {
                    email: email,
                    otp: otp,
                    username: name,
                    phone: phone,
                    password: password,
                    role: role,
                    profilePicture: profilePictureBase64
                };

                // Add driver fields if applicable
                if (role === 'DRIVER' || role === 'BOTH') {
                    registerData.vehicleModel = document.getElementById('vehicleModel').value.trim();
                    registerData.vehiclePlate = document.getElementById('vehiclePlate').value.trim();
                    registerData.vehicleCapacity = parseInt(document.getElementById('vehicleCapacity').value);
                }

                console.log('üîÑ Registering user:', email);

                const response = await fetch(`${API_BASE_URL}/register-with-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const data = await response.json();
                console.log('üì¶ Registration response:', data);

                if (data.success) {
                    console.log('‚úÖ Registration successful!');
                    showAlert('register', '‚úÖ Account created successfully! Redirecting...', true);

                    // Store authentication in localStorage, sessionStorage, AND cookies
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data));
                    localStorage.setItem('userData', JSON.stringify(data.data));
                    
                    // ALSO store in sessionStorage for immediate access
                    sessionStorage.setItem('token', data.data.token);
                    sessionStorage.setItem('authToken', data.data.token);
                    sessionStorage.setItem('user', JSON.stringify(data.data));
                    sessionStorage.setItem('userData', JSON.stringify(data.data));
                    
                    // ALSO store in cookie as backup
                    document.cookie = `authToken=${data.data.token}; path=/; max-age=86400`;
                    document.cookie = `userRole=${data.data.role}; path=/; max-age=86400`;

                    console.log('‚úÖ Auth data stored in localStorage, sessionStorage, AND cookies');
                    console.log('üé≠ User role:', data.data.role);

                    // Redirect based on role with delay
                    setTimeout(() => {
                        const userRole = data.data.role ? data.data.role.toString().toUpperCase() : 'PASSENGER';
                        if (userRole === 'DRIVER' || userRole === 'BOTH') {
                            window.location.href = '/driver-dashboard.html';
                        } else {
                            window.location.href = '/passenger-dashboard.html';
                        }
                    }, 300);

                } else {
                    console.log('‚ùå Registration failed:', data.message);
                    showAlert('register', data.message || 'Registration failed', false);
                }

            } catch (error) {
                console.error('‚ùå Registration error:', error);
                showAlert('register', 'Registration failed. Please try again.', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        }

        // OLD Registration Function (kept as fallback - not used anymore)
        async function handleRegistration() {
            console.log('üöÄ Starting registration process...');

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const role = document.getElementById('registerRole').value;
            const profilePictureFile = document.getElementById('registerProfilePicture').files[0];
            const btn = document.getElementById('registerBtn');

            console.log('üìù Form data:', { name, email, phone, role, hasProfilePicture: !!profilePictureFile });

            if (!name || !email || !phone || !password || !role) {
                console.log('‚ùå Missing required fields');
                showAlert('register', 'Please fill in all required fields', false);
                return;
            }

            if (password.length < 6) {
                console.log('‚ùå Password too short');
                showAlert('register', 'Password must be at least 6 characters long', false);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating Account...';
            clearAlert('register');

            try {
                let profilePictureBase64 = null;

                // Convert profile picture to base64 if uploaded
                if (profilePictureFile) {
                    try {
                        profilePictureBase64 = await getBase64(profilePictureFile);
                        console.log('üì∑ Profile picture converted to base64');
                    } catch (error) {
                        console.error('‚ùå Error converting image:', error);
                        showAlert('register', 'Error processing profile picture. Please try again.', false);
                        return;
                    }
                }

                console.log('üîÑ Registering user:', email);

                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: name,
                        email: email,
                        phone: phone,
                        password: password,
                        role: role,
                        profilePicture: profilePictureBase64
                    })
                });

                console.log('üì° Registration response status:', response.status);

                const data = await response.json();
                console.log('üì¶ Registration response:', data);

                if (data.success) {
                    console.log('‚úÖ Registration successful!');
                    showAlert('register', 'Account created successfully! Please login.', true);

                    // Clear form
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPhone').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerRole').value = '';
                    document.getElementById('registerProfilePicture').value = '';
                    document.getElementById('profilePreview').style.display = 'none';
                    document.getElementById('uploadPlaceholder').style.display = 'block';

                    // Switch to login modal after 2 seconds
                    setTimeout(() => {
                        switchModal('register', 'login');
                        // Pre-fill email in login form
                        document.getElementById('loginEmail').value = email;
                    }, 2000);

                } else {
                    console.log('‚ùå Registration failed:', data.message);
                    showAlert('register', data.message || 'Registration failed', false);
                }

            } catch (error) {
                console.error('‚ùå Registration error:', error);

                // Try to get more detailed error information
                if (error.response) {
                    const errorData = await error.response.json();
                    showAlert('register', errorData.message || 'Registration failed. Please try again.', false);
                } else {
                    showAlert('register', 'Registration failed. Please check your connection and try again.', false);
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>

</html>